<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="A primer on Windows drivers" /><meta property="og:locale" content="en_US" /><meta name="description" content="HEVD" /><meta property="og:description" content="HEVD" /><link rel="canonical" href="https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/" /><meta property="og:url" content="https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/" /><meta property="og:site_name" content="Hello World" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-01T09:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="A primer on Windows drivers" /><meta name="twitter:site" content="@wojtekgoo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-01T09:00:00+01:00","datePublished":"2022-01-01T09:00:00+01:00","description":"HEVD","headline":"A primer on Windows drivers","mainEntityOfPage":{"@type":"WebPage","@id":"https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/"},"url":"https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/"}</script> --><title>A primer on Windows drivers | Hello World</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/photo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hello World</a></div><div class="site-subtitle font-italic">A tagline</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://www.linkedin.com/in/wojtekgusztyla/" aria-label="linkedin" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/wojtekgoo" aria-label="github" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wojtekgoo','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>A primer on Windows drivers</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>A primer on Windows drivers</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Wojtek </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jan 1, 2022, 9:00 AM +0100" prep="on" > Jan 1 <i class="unloaded">2022-01-01T09:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1612 words">8 min</span> <span id="pv" class="pageviews"><i class="fas fa-spinner fa-spin fa-fw"></i></span></div></div><div class="post-content"><h2 id="hevd"><span class="myheader">HEVD</span></h2><p>Over the next few posts in this series I am going to be looking at Windows kernel exploitation via the <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">Hacksys Extreme Vulnerable Driver</a>. This is a wonderful piece of software with intentional bugs in it, created for those like me who are just starting out in low-level exploitation.<br /> There are multiple good articles out there explaining various HEVD vulnerabilities, so almost nothing I create in this blog will be new. However, I noticed that for every exploit I had to combine many different resources to really understand what the vulnerability is about and how to use it, as I could never find a single page that would do the job. Hence, I decided to describe it once again for my own reference.</p><p><strong>I will not explain:</strong></p><ul><li>how to install HEVD<li>how to set up a lab environment<li>basic subjects like buffer overflows theory, function calls, APIs etc.</ul><p>To set up your lab, read e.g. <a href="https://fluidattacks.com/blog/windows-kernel-debugging/">this</a> or <a href="https://www.exploit-db.com/docs/44094">this</a>.</p><h2 id="windows-internals"><span class="myheader">Windows internals</span></h2><p>Before we deep-dive into the driver exploitation, I made a small refresher of some concepts I think are most relevant to the topic. Understanding in general what role a driver has and how it receives requests from the user is crucial to learn how to find vulnerabilities in the real-world code. This is by no means exhaustive list of topics but will make sure we are on the same page before we continue.</p><h4 id="modes"><span class="myheader">Modes</span></h4><p>A processor in computer with Windows operates in two modes: <em>user mode</em> and <em>kernel mode</em>. It switches between them depending on what type of code is running. Applications run in user mode and core operating system components run in kernel mode.</p><ul><li><strong>User Mode</strong>: here, the executing code has limited power - it cannot for example access hardware directly or reference every memory address. To do this, code running in UM must use special APIs that will handle it.<li><strong>Kernel Mode</strong>: here, the executing code has unrestricted access to the hardware, can use any CPU instruction or reference any memory address<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></ul><p>System drivers, like HEVD, operate in Kernel Mode. It means that if we are able to discover and exploit a vulnerability in the driver, we can force it to execute a piece of malicious code that we placed in UM (like shellcode) with high privileges stemming from the KM.</p><h4 id="process"><span class="myheader">Process</span></h4><p>When an application starts, Windows creates a <em>process</em> for it. Think of a process as a container that holds all the necessary information for application to run. If the application runs in user-mode, process provides the app with a private virtual address space.</p><h4 id="thread"><span class="myheader">Thread</span></h4><p>TODO</p><h4 id="virtual-address-space"><span class="myheader">Virtual address space</span></h4><p>TODO: virtual addr space definition</p><p>Because a user-mode application’s virtual address space is private, one application cannot alter data that belongs to another application. Each application runs in isolation, and if an application crashes, the crash is limited to that one application. Other applications and the operating system are not affected by the crash.</p><p>In addition to being private, the virtual address space of a user-mode application is limited. A processor running in user mode cannot access virtual addresses that are reserved for the operating system. Limiting the virtual address space of a user-mode application prevents the application from altering, and possibly damaging, critical operating system data.</p><p>All code that runs in kernel mode shares a single virtual address space. This means that a kernel-mode driver is not isolated from other drivers and the operating system itself. If a kernel-mode driver accidentally writes to the wrong virtual address, data that belongs to the operating system or another driver could be compromised. If a kernel-mode driver crashes, the entire operating system crashes.</p><h4 id="memory-regions"><span class="myheader">Memory regions</span></h4><p>In User Mode there are two main memory regions used for functions implementation: <em>stack</em> and <em>heap</em>.</p><p>Stack is a region of memory where data is added and removed in such way that data added last will be removed first and data added first will be removed in the end (Last-In-First-Out queue). Imagine building a tower from wooden bricks. If you want to move a piece at the bottom without collapsing whole tower, first you need to remove all bricks that you added later that reside on the top. <br /> In most Operating Systems each thread has its own stack region in memory. Functions executed by the thread may store some of their local data on the stack and have to remove all the data placed on the stack when they finish execution.</p><p>TODO: define heap</p><p>In Kernel Mode, up to Windows 10 19H1 (1903), there were kernel stack and kernel pool which played similar role to the userland heap.<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p><h4 id="windows-drivers"><span class="myheader">Windows Drivers</span></h4><p>Driver is a software interacts with the kernel and/or controls hardware resources. Drivers mainly let OS and hardware communicate with each other. It sits and waits for the system to call it when it needs something, like starting/using/controlling a hardware device. Then, the driver interprets incoming OS request and translates it into instructions understood by the device and vice versa. <br /> You can think of a driver as a DLL that is loaded into the kernel address space and executes with the same privilege as the kernel. A driver does not have a main execution thread; it contains code that can be called by the kernel when certain events occur. Such events may be interrupts or processes requiring the operating system to do stuff; the kernel handles those interrupts and may execute appropriate drivers to fulfill the requests.<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup></p><h5 id="driverentry"><span class="myheader">DriverEntry</span></h5><p>After a driver is loaded, first piece of code that is called is a <code>DriverEntry</code> function:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span>
    <span class="n">PDRIVER_OBJECT</span>  <span class="n">DriverObject</span><span class="p">,</span>
    <span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The <code>DriverObject</code> argument is a pointer to the <code>DRIVER_OBJECT</code> structure filled out by the I/O manager during the driver loading process that holds information about the driver itself. I/O manager creates a <code>DRIVER_OBJECT</code> for every driver loaded in the system.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/windbg_driver_object.png" alt="DRIVER_OBJECT" /> <em>DRIVER_OBJECT structure</em></p><p>One of the most important fields in the <code>DriverObject</code> structure is <code>MajorFunctions</code> which is an array of function pointers. <br /> Whenever driver receives request, it invokes relevant routine pointed by index from the array - more on that later.</p><h5 id="devices"><span class="myheader">Devices</span></h5><p>The operating system represents devices by <em>device objects</em>. They serve as the target of all operations on the device. A driver creates device object for every device the driver handles. So if a device is served by multiple drivers, each one will create its own device object.</p><p>If a device wants to be accessible for user processes, a driver needs to define the device by creating a <code>DEVICE_OBJECT</code> structure and a symbolic link (symlink). One example is <code>C:\</code> symlink that represents storage device. We can check it with <code>WinObj</code> tool from SysInternals suite:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/WinObj_symlink.png" alt="Symlink in WinObj" /> <em>WinObj showing symlink for a storage device</em></p><h5 id="ioctl-and-irp"><span class="myheader">IOCTL and IRP</span></h5><p>Drivers receive requests from userland in form of standard APIs (like ReadFile or WriteFile) or I/O Control Codes (IOCTL), if the request does not fit into standard API. IOCTLs are 32 bit integers that encodes information what action hardware needs to take. IOCTL is generated with <code>DeviceIoControl</code> API located in kernel32.dll in user-mode and is passed to the kernel-mode I/O Manager.</p><p>Windows I/O Manager takes the standard API request or IOCTL and builds <strong>I/O Request Packet (IRP)</strong> to describe the I/O request to kernel-mode components and determine which device should process the request. IRP is a kernel structure used to represent I/O request as it moves around the kernel system. It has all the information that the driver needs to perform a given action on an I/O request. <br /> So when a program issues a request to a device, an IRP is created in kernel space to reflect that request. In summary, an IOCTL is a particular user-mode type of “miscellaneous” request to a device driver. An IRP is a kernel-mode data structure for managing all kinds of requests inside the Windows driver kernel architecture.<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">4</a></sup></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/windbg_irp_structure.png" alt="IRP structure" /> <em>IRP structure</em></p><p>IOCTL control codes have following layout<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">5</a></sup></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/ioctl_layout.png" alt="IOCTL layout" /> <em>IOCTL layout</em></p><ul><li><code>Device Type</code> identifies the device type. Value less than 0x8000 are used by Microsoft.<li><code>Required Access</code> specifies access level that a caller opening the device needs to request. It can be <em>FILE_ANY_ACCESS (0x0), FILE_READ_ACCESS (0x1)</em> or <em>FILE_WRITE_ACCESS (0x2)</em><li><code>Function Code</code> identifies function to be performed by the driver. Values less than 0x800 are reserved by Microsoft<li><code>Transfer Type</code> indicates how the system will pass data between the caller of <code>DeviceIoControl</code> and the driver that handles the IRP. It can be <em>METHOD_BUFFERED (0x0), METHOD_IN_DIRECT (0x1), METHOD_OUT_DIRECT (0x2), METHOD_NEITHER (0x3)</em></ul><p>To decode I/O Control Codes we can use the <code>CTL_CODE</code> macro that comes with the <em>wdm.h</em> or <em>ntddk.h</em> headers or refer to an <a href="https://www.osronline.com/article.cfm%5earticle=229.htm">online tool</a>.</p><h5 id="user-kernel-communication"><span class="myheader">User-Kernel communication</span></h5><p>Now when we understand most important data objects, we can try to grasp how requests are passed from the user-mode apps to the kernel-mode drivers.</p><p>When user-mode code calls some kernel32.dll API like <code>ReadFile</code> or <code>DeviceIoControl</code>, the request is transferred to ntdll.dll <br /> Ntdll prepares registers, sets the stack and calls SYSENTER (in x86) or SYSCALL (x64) instruction that switches to kernel mode. The request is handled then by the I/O Manager, that creates IRP packet and sends it to the appropriate driver. <br /> The IRP packet contains a major function code that tells the driver how to act and which specific function from the <code>MajorFunctions</code> array to call. There are many major function codes and each of them corresponds with a user-mode function, but the most important ones are:</p><ul><li><code>IRP_MJ_CREATE</code>, relates to user-mode <code>CreateFile</code><li><code>IRP_MJ_READ</code>, relates to <code>ReadFile</code><li><code>IRP_MJ_DEVICE_CONTROL</code>, relevant to <code>DeviceIoControl</code></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/IOCTL_flow.png" alt="IOCTL flow" /> <em>IOCTL flow around the system</em></p><p>Equipped with this basic knowledge, let’s move on to the next article and analyze the first vulnerability in HEVD - <a href="https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/">the Stack Overflow</a>.</p><h2 id="references"><span class="myheader">References<span></span></span></h2><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/concepts-and-knowledge-for-all-driver-developers <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:2" role="doc-endnote"><p>In March 2019 Microsoft brought Segment Heap used in user land to the kernel <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:3" role="doc-endnote"><p>https://voidsec.com/exploiting-system-mechanic-driver/ <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:5" role="doc-endnote"><p>https://stackoverflow.com/questions/18901467/what-is-the-difference-between-an-ioctl-and-an-irp <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:4" role="doc-endnote"><p>https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/defining-i-o-control-codes <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hevd/'>HEVD</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/driver/" class="post-tag no-text-decoration" >driver</a> <a href="/tags/x86/" class="post-tag no-text-decoration" >x86</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=A primer on Windows drivers - Hello World&url=https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=A primer on Windows drivers - Hello World&u=https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/driver/">driver</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/kernel-exploitation/">kernel exploitation</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/HEVD_Stack_Overflow/"><div class="card-body"> <span class="timeago small" > Jan 4 <i class="unloaded">2022-01-04T09:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HEVD: Stack Overflow exploitation</h3><div class="text-muted small"><p> Loading HEVD driver In this post we will be exploiting the Stack Overflow vulnerability in the HEVD v3 driver. We’re going to use Windows 7 SP1 as our target. To get better understanding of how dr...</p></div></div></a></div><div class="card"> <a href="/posts/Glossary/"><div class="card-body"> <span class="timeago small" > Dec 31, 2021 <i class="unloaded">2021-12-31T09:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Glossary</h3><div class="text-muted small"><p> TEST TODO</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Glossary/" class="btn btn-outline-primary" prompt="Older"><p>Glossary</p></a> <a href="/posts/HEVD_Stack_Overflow/" class="btn btn-outline-primary" prompt="Newer"><p>HEVD: Stack Overflow exploitation</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/wojtekgoo">Wojtek</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/driver/">driver</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/kernel-exploitation/">kernel exploitation</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://wojtekgoo.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
